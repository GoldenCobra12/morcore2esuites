<Module xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:noNamespaceSchemaLocation="../FrankConfig.xsd">
    <Adapter name="NewResponse_Notification">
        <Receiver name="Response_Notification">
            <JavaListener name="Response_Notification"/>
        </Receiver>

        <Pipeline>

            <Exits>
                <Exit name="Exit" state="SUCCESS"/>
                <Exit name="Exception" state="ERROR"/>
                <Exit name="Reject" state="REJECTED"/>
            </Exits>

        <!-- TO DO: Add Url Param with Root-url as value when in test-environment -->
        <SenderPipe name="Send2MorCore">
            <HttpSender name="GetNotification" methodType="GET" url="/melding/${meldingUuid}"/>
                <Param name="meldingUuid" sessionkey="originalMessage" xpathExpression="//meldingUuid"/>
            <Forward name="success" path="Json2Xml"/>
        </SenderPipe>

        <JsonPipe name="Json2Xml" direction="JSON2XML" prettyPrint="true">
            <Forward name="success" path="CorrectFormat"/>
            <Forward name="exception" path="Exception"/>
        </JsonPipe>

        <XsltPipe name="CorrectFormat" styleSheetName="xsl/TaakApiInt/GetNotification.xsl" outputType="XML">
            <Forward name="success" path="XmlCheck"/>
            <Forward name="exception" path="Exception"/>
        </XsltPipe>

        <XmlValidatorPipe name="XmlCheck" schema="xsd/TaakApiInt/ValidateGetMelding.xsd" root="root">
            <Forward name="success" path="Xml2Json"/>
            <Forward name="failure" path="Reject"/>
        </XmlValidatorPipe>

        <JsonPipe name="Xml2Json" direction="XML2JSON">
            <Forward name="success" path="Exit"/>
            <Forward name="exception" path="Exception"/>
        </JsonPipe>

        <!-- Possible config update: There is a inconsistency in the .json file and the .xml file after internal transformation of the JsonXsltPipe and Json2XmlValidatorPipe.
        UPDATE: JsonXsltPipe and Json2XmlValidatorPipe are broken in source code. Only update when source code is fixed!

        <JsonXsltPipe name="CorrectResponse" styleSheetName="xsl/TaakApiInt/GetNotification.xsl">
            <Forward name="success" path="JsonValidator"/>
            <Forward name="Exception" path="failure"/>
        </JsonXsltPipe>

        <Json2XmlValidatorPipe name="JsonValidator" schema="xsd/TaakApiInt/ValidateGetMelding.xsd" root="root" inputFormatSessionKey="InputFormat" outputFormat="JSON">
            <Forward name="success" path="Exit"/>
            <Forward name="Exception" path="failure"/>
        </Json2XmlValidatorPipe> -->

        </Pipeline>
    </Adapter>

    <Adapter name="NewResponse_NotificationTasks">
        <Receiver name="Response_NotificationTasks">
            <JavaListener name="Response_Notificationtasks"/>
        </Receiver>

        <Pipeline>

            <Exits>
                <Exit name="Exit" state="SUCCESS"/>
                <Exit name="Exception" state="ERROR"/>
                <Exit name="Reject" state="REJECTED"/>
            </Exits>
        
        <!-- TO DO: Add Url Param with Root-url as value when in test-environment -->

        <SenderPipe name="Send2MorCore">
            <HttpSender name="GetNotificationTasks" methodType="GET" url="/melding/${meldingUuid}/taakopdracht"/>
                <Param name="meldingUuid" sessionkey="originalMessage" xpathExpression="//meldingUuid"/>
            <Forward name="success" path="Json2Xml"/>
            <Forward name="exception" path="Exception"/>
        </SenderPipe>

        <JsonPipe name="Json2Xml" prettyPrint="true">
            <Forward name="success" path="CorrectFormat"/>
            <Forward name="exception" path="Exception"/>
        </JsonPipe>

        <XsltPipe name="CorrectFormat" styleSheetName="xsl/TaakApiInt/GetNotificationTasks.xsl" outputType="XML">
            <Forward name="success" path="XmlCheck"/>
            <Forward name="exception" path="Exception"/>
        </XsltPipe>

        <XmlValidatorPipe name="XmlCheck" schema="xsd/TaakApiInt/ValidateGetMeldingTaak.xsd" root="root">
            <Forward name="success" path="Xml2Json"/>
            <Forward name="failure" path="Reject"/>
        </XmlValidatorPipe>

        <JsonPipe name="Xml2Json" direction="XML2JSON">
            <Forward name="success" path="Exit"/>
            <Forward name="exception" path="Exception"/>
        </JsonPipe>

        <!-- Possible config update: There is a inconsistency in the .json file and the .xml file after internal transformation of the JsonXsltPipe and Json2XmlValidatorPipe. 
        UPDATE: JsonXsltPipe and Json2XmlValidatorPipe are broken in source code. Only update when source code is fixed!
            
            <JsonXsltPipe name="CorrectResponse" styleSheetName="xsl/TaakApiInt/GetNotificationTasks.xsl">
            <Forward name="success" path="JsonValidator"/>
            <Forward name="failure" path="Exception"/>
        </JsonXsltPipe>

        <Json2XmlValidatorPipe name="JsonValidator" schema="xsd/TaakApiInt/ValidateGetMeldingTaak.xsd" root="root" inputFormatSessionKey="InputFormat" outputFormat="JSON">
            <Forward name="success" path="Exit"/>
            <Forward name="failure" path="Exception"/>
        </Json2XmlValidatorPipe>  -->

        </Pipeline>
    </Adapter>

    <!-- Pipeline only sends a notification of a change. Can not validate message because there is no body. -->

    <Adapter name="NewResponse_TaskNotification" active="false">
        <Receiver name="Response_TaskNotification">
            <JavaListener name="Response_TaskNotification"/>
        </Receiver>

        <Pipeline>

            <Exits>
                <Exit name="Exit" state="SUCCESS" code="204"/>
                <Exit name="Exception" state="ERROR" code="500"/>
                <Exit name="Reject" state="REJECTED"/>
            </Exits>

        <!-- TO DO: Add Url Param with Root-url as value when in test-environment -->

        <SenderPipe name="Send2MorCore">
            <HttpSender name="SendNotification" methodType="POST" url="/melding/${meldingUuid}/taakopdracht/${taakOpdrachtUuid}/notificatie"/>
                <Param name="meldingUuid" sessionkey="originalMessage" xpathExpression="//meldingUuid"/>
                <Param name="taakOpdrachtUuid" sessionkey="originalMessage" xpathExpression="//taakOpdrachtUuid"/>
            <Forward name="success" path="Exit"/>
            <Forward name="exception" path="Exception"/>
        </SenderPipe>

        </Pipeline>
    </Adapter>
</Module>