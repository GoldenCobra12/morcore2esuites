<Module xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:noNamespaceSchemaLocation="../FrankConfig.xsd">
    <Adapter name="ESB_DeleteZaak">
        <Receiver name="ESB_DeleteZaak">
            <JavaListener name="ESB_DeleteZaak" />
        </Receiver>

        <Pipeline>
            <Exits>
                <Exit name="Exit" state="SUCCESS" code="201"/>
                <Exit name="BadRequest" state="ERROR" code="400"/>
                <Exit name="Forbidden" state="ERROR" code="403"/>
                <Exit name="Conflict" state="ERROR" code="409"/>
                <Exit name="ServerError" state="ERROR" code="500"/>
            </Exits>
            
            <PutSystemDateInSessionPipe name="StoreSystemDate" >
                <Forward name="success" path="StoreToelichting"/>
                <Forward name="exception" path="exception"/>
            </PutSystemDateInSessionPipe>
            
            <XsltPipe name="StoreToelichting" getInputFromSessionKey="originalMessage"
            xpathExpression="//reden" storeResultInSessionKey="toelichtingHeader" >
                <Forward name="success" path="CreateDeleteZaakRequest"/>
                <Forward name="exception" path="exception"/>
            </XsltPipe>
            
            <XsltPipe name="CreateDeleteZaakRequest" getInputFromSessionKey="originalMessage" styleSheetName="xsl/ESBZGWApi/DeleteZaakRequest.xsl">
                <Param name="currentDate" sessionKey="systemDate" />
                <Forward name="success" path="SendToESB"/>
                <Forward name="exception" path="exception"/>
            </XsltPipe>
            
            <JsonPipe name="XmlToJson" direction="XML2JSON" />
            
            <!-- TODO: Get uuid from the url. Marcel advised to get the code for this from OpenZaak. -->
            <SenderPipe name="SendToESB">
                <HttpSender name="SendToESB" methodType="POST" url="/statussen"
                    headersParams="X-Audit-Toelichting">
                    <Param name="X-Audit-Toelichting" sessionKey="toelichtingHeader" />
                </HttpSender>
                <Forward name="success" path="Exit"/>
                <Forward name="exception" path="exception"/>
                <Forward name="timeout" path="timeout"/>
                <Forward name="illigalResult" path="illigalResult"/>
                <Forward name="interrupt" path="interrupt"/>
            </SenderPipe>

            <FixedResultPipe name="exception" filename="ErrorResponses/BadRequest.json">
                <Forward name="success" path="BadRequest"/>
            </FixedResultPipe>

            <FixedResultPipe name="timeout" filename="ErrorResponses/ServerError.json">
                <Forward name="success" path="ServerError"/>
            </FixedResultPipe>
            
            <FixedResultPipe name="illigalResult" filename="ErrorResponses/Forbidden.json">
                <Forward name="success" path="Forbidden"/>
            </FixedResultPipe>

            <FixedResultPipe name="interrupt" filename="ErrorResponses/Conflict.json">
                <Forward name="success" path="Conflict"/>
            </FixedResultPipe>

        </Pipeline>
    </Adapter>

    <Adapter name="ESB_PostZaak">
        <Receiver name="ESB_PostZaak">
            <JavaListener name="ESB_PostZaak" />
        </Receiver>

        <Pipeline>
            <Exits>
                <Exit name="Exit" state="SUCCESS" code="201"/>
                <Exit name="BadRequest" state="ERROR" code="400"/>
                <Exit name="Forbidden" state="ERROR" code="403"/>
                <Exit name="Conflict" state="ERROR" code="409"/>
                <Exit name="ServerError" state="ERROR" code="500"/>
            </Exits>

            <PutSystemDateInSessionPipe name="StoreSystemDate" />

            <!-- TODO: Replace with ibislocalsender once Seppe's branch has been merged. -->
            <SenderPipe name="RequestMeldingInfo" storeResultInSessionKey="meldingInfo">
                <HttpSender name="SendToESB" methodType="GET" url="/zaken/${uuid}"
                    headersParams="Accept-Crs,Content-Crs">
                    <Param name="Accept-Crs" value="EPSG:4326" />
                    <Param name="Content-Crs" value="EPSG:4326" />
                    <Param name="uuid" sessionKey="originalMessage" xpathExpression="//uuid" />
                </HttpSender>
                <Forward name="success" path="RequestOpdrachtInfo"/>
                <Forward name="exception" path="exception"/>
                <Forward name="timeout" path="timeout"/>
                <Forward name="illigalResult" path="illigalResult"/>
                <Forward name="interrupt" path="interrupt"/>
            </SenderPipe>

            <!-- TODO: Replace with ibislocalsender once Seppe's branch has been merged. -->
            <SenderPipe name="RequestOpdrachtInfo" storeResultInSessionKey="opdrachtInfo">
                <HttpSender name="SendToESB" methodType="GET" url="/zaken/${uuid}"
                    headersParams="Accept-Crs,Content-Crs">
                    <Param name="Accept-Crs" value="EPSG:4326" />
                    <Param name="Content-Crs" value="EPSG:4326" />
                    <Param name="uuid" sessionKey="originalMessage" xpathExpression="//uuid" />
                </HttpSender>
                <Forward name="success" path="StoreToelichtingHeader"/>
                <Forward name="exception" path="exception"/>
                <Forward name="timeout" path="timeout"/>
                <Forward name="illigalResult" path="illigalResult"/>
                <Forward name="interrupt" path="interrupt"/>
            </SenderPipe>

            <PutInSessionPipe name="StoreToelichtingHeader" sessionKey="toelichtingHeader"
                getInputFromFixedValue="TestValue">
                <Forward name="success" path="CreatePostZaakRequest"/>
                <Forward name="exception" path="exception"/>
            </PutInSessionPipe>

            <XsltPipe name="CreatePostZaakRequest" styleSheetName="xsl/ESBZGWApi/PostZaakRequest.xsl"
                getInputFromSessionKey="originalMessage">
                <Param name="currentDate" sessionKey="systemDate" />
                <Param name="meldingInfo" sessionKey="meldingInfo" />
                <Param name="opdrachtInfo" sessionKey="opdrachtInfo" />
            </XsltPipe>

            <JsonPipe name="XmlToJson" direction="XML2JSON">
                <Forward name="success" path="SendToESB"/>
                <Forward name="exception" path="exception"/>

            <SenderPipe name="SendToESB">
                <HttpSender name="SendToESB" methodType="POST" url="${Esuites.ESB.root-url}/melding/${meldingUuid}"
                    headersParams="X-Audit-Toelichting,Accept-Crs,Content-Crs">
                    <Param name="X-Audit-Toelichting" sessionKey="toelichtingHeader" />
                    <Param name="Accept-Crs" value="EPSG:4326" />
                    <Param name="Content-Crs" value="EPSG:4326" />
                </HttpSender>
                <Forward name="success" path="Exit"/>
                <Forward name="exception" path="exception"/>
                <Forward name="timeout" path="timeout"/>
                <Forward name="illigalResult" path="illigalResult"/>
                <Forward name="interrupt" path="interrupt"/>
            </SenderPipe>

            <FixedResultPipe name="exception" filename="ErrorResponses/BadRequest.json">
                <Forward name="success" path="BadRequest"/>
            </FixedResultPipe>

            <FixedResultPipe name="timeout" filename="ErrorResponses/ServerError.json">
                <Forward name="success" path="ServerError"/>
            </FixedResultPipe>
            
            <FixedResultPipe name="illigalResult" filename="ErrorResponses/Forbidden.json">
                <Forward name="success" path="Forbidden"/>
            </FixedResultPipe>

            <FixedResultPipe name="interrupt" filename="ErrorResponses/Conflict.json">
                <Forward name="success" path="Conflict"/>
            </FixedResultPipe>

        </Pipeline>
    </Adapter>

    <Adapter name="ESB_GetZaak">
        <Receiver name="ESB_GetZaak">
            <JavaListener name="ESB_GetZaak" />
        </Receiver>

        <Pipeline>
            <Exits>
                <Exit name="Exit" state="SUCCESS" code="200"/>
                <Exit name="BadRequest" state="ERROR" code="400"/>
                <Exit name="Forbidden" state="ERROR" code="403"/>
                <Exit name="Conflict" state="ERROR" code="409"/>
                <Exit name="ServerError" state="ERROR" code="500"/>
            </Exits>

            <!-- TODO: Get uuid from the url. Marcel advised to get the code for this from OpenZaak.  -->
            <XsltPipe name="CreateGetZaakRequest" styleSheetName="xsl/ESBZGWApi/GetZaakRequest.xsl"
                getInputFromSessionKey="originalMessage">
                <Param name="currentDate" sessionKey="systemDate" />
                <Param name="meldingInfo" sessionKey="meldingInfo" />
                <Param name="opdrachtInfo" sessionKey="opdrachtInfo" />
                <Forward name="success" path="SendToESB"/>
                <Forward name="exception" path="exception"/>
            </XsltPipe>

            <SenderPipe name="SendToESB">
                <HttpSender name="SendToESB" methodType="GET" url="/zaken/${uuid}"
                    headersParams="Accept-Crs,Content-Crs">
                    <Param name="Accept-Crs" value="EPSG:4326" />
                    <Param name="Content-Crs" value="EPSG:4326" />
                    <Param name="uuid" sessionKey="originalMessage" xpathExpression="//uuid" />
                </HttpSender>
                <Forward name="success" path="Exit"/>
                <Forward name="exception" path="exception"/>
                <Forward name="timeout" path="timeout"/>
                <Forward name="illigalResult" path="illigalResult"/>
                <Forward name="interrupt" path="interrupt"/>
            </SenderPipe>

            <FixedResultPipe name="exception" filename="ErrorResponses/BadRequest.json">
                <Forward name="success" path="BadRequest"/>
            </FixedResultPipe>

            <FixedResultPipe name="timeout" filename="ErrorResponses/ServerError.json">
                <Forward name="success" path="ServerError"/>
            </FixedResultPipe>
            
            <FixedResultPipe name="illigalResult" filename="ErrorResponses/Forbidden.json">
                <Forward name="success" path="Forbidden"/>
            </FixedResultPipe>

            <FixedResultPipe name="interrupt" filename="ErrorResponses/Conflict.json">
                <Forward name="success" path="Conflict"/>
            </FixedResultPipe>
            
        </Pipeline>
    </Adapter>

</Module>